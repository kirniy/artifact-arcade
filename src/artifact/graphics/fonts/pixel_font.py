"""Pixel font system with Cyrillic support for ARTIFACT displays."""

from typing import Dict, List, Tuple, Optional
from dataclasses import dataclass
import numpy as np
from numpy.typing import NDArray


@dataclass
class PixelFont:
    """A bitmap pixel font with character definitions.

    Each character is defined as a 2D list of 0s and 1s,
    where 1 represents a pixel that should be drawn.
    """

    name: str
    char_height: int
    char_width: int  # Default width, individual chars may vary
    spacing: int = 1  # Pixels between characters
    glyphs: Dict[str, List[List[int]]] = None

    def __post_init__(self):
        if self.glyphs is None:
            self.glyphs = {}

    def add_glyph(self, char: str, bitmap: List[List[int]]) -> None:
        """Add a character glyph to the font."""
        self.glyphs[char] = bitmap

    def get_glyph(self, char: str) -> Optional[List[List[int]]]:
        """Get the bitmap for a character."""
        return self.glyphs.get(char)

    def get_char_width(self, char: str) -> int:
        """Get the width of a specific character."""
        glyph = self.glyphs.get(char)
        if glyph and glyph[0]:
            return len(glyph[0])
        return self.char_width

    def measure_text(self, text: str) -> Tuple[int, int]:
        """Calculate the pixel dimensions of rendered text.

        Returns:
            Tuple of (width, height) in pixels
        """
        if not text:
            return (0, 0)

        total_width = 0
        for i, char in enumerate(text):
            if char == ' ':
                total_width += self.char_width
            else:
                total_width += self.get_char_width(char)

            if i < len(text) - 1:
                total_width += self.spacing

        return (total_width, self.char_height)


def draw_text_bitmap(
    buffer: NDArray[np.uint8],
    text: str,
    x: int,
    y: int,
    color: Tuple[int, int, int],
    font: PixelFont,
    scale: int = 1,
) -> Tuple[int, int]:
    """Draw text using a pixel font onto a numpy buffer.

    Args:
        buffer: Target numpy array (height, width, 3)
        text: Text string to draw
        x: Starting x coordinate
        y: Starting y coordinate
        color: RGB color tuple
        font: PixelFont instance to use
        scale: Scale factor (1 = original size)

    Returns:
        Tuple of (width, height) of rendered text
    """
    if not text:
        return (0, 0)

    h, w = buffer.shape[:2]
    cursor_x = x

    for char in text:
        if char == ' ':
            cursor_x += font.char_width * scale + font.spacing * scale
            continue

        glyph = font.get_glyph(char)
        if glyph is None:
            # Try uppercase
            glyph = font.get_glyph(char.upper())
        if glyph is None:
            # Use placeholder
            glyph = font.get_glyph('?')
        if glyph is None:
            cursor_x += font.char_width * scale + font.spacing * scale
            continue

        # Draw the glyph
        for row_idx, row in enumerate(glyph):
            for col_idx, pixel in enumerate(row):
                if pixel:
                    for sy in range(scale):
                        for sx in range(scale):
                            px = cursor_x + col_idx * scale + sx
                            py = y + row_idx * scale + sy
                            if 0 <= px < w and 0 <= py < h:
                                buffer[py, px] = color

        char_width = len(glyph[0]) if glyph else font.char_width
        cursor_x += char_width * scale + font.spacing * scale

    return (cursor_x - x - font.spacing * scale, font.char_height * scale)


def get_default_font() -> PixelFont:
    """Get the default 3x5 Latin pixel font."""
    font = PixelFont(
        name="default_3x5",
        char_height=5,
        char_width=3,
        spacing=1,
    )

    # Latin uppercase letters (3x5)
    latin_glyphs = {
        'A': [[0,1,0], [1,0,1], [1,1,1], [1,0,1], [1,0,1]],
        'B': [[1,1,0], [1,0,1], [1,1,0], [1,0,1], [1,1,0]],
        'C': [[0,1,1], [1,0,0], [1,0,0], [1,0,0], [0,1,1]],
        'D': [[1,1,0], [1,0,1], [1,0,1], [1,0,1], [1,1,0]],
        'E': [[1,1,1], [1,0,0], [1,1,0], [1,0,0], [1,1,1]],
        'F': [[1,1,1], [1,0,0], [1,1,0], [1,0,0], [1,0,0]],
        'G': [[0,1,1], [1,0,0], [1,0,1], [1,0,1], [0,1,1]],
        'H': [[1,0,1], [1,0,1], [1,1,1], [1,0,1], [1,0,1]],
        'I': [[1,1,1], [0,1,0], [0,1,0], [0,1,0], [1,1,1]],
        'J': [[0,0,1], [0,0,1], [0,0,1], [1,0,1], [0,1,0]],
        'K': [[1,0,1], [1,0,1], [1,1,0], [1,0,1], [1,0,1]],
        'L': [[1,0,0], [1,0,0], [1,0,0], [1,0,0], [1,1,1]],
        'M': [[1,0,1], [1,1,1], [1,0,1], [1,0,1], [1,0,1]],
        'N': [[1,0,1], [1,1,1], [1,1,1], [1,0,1], [1,0,1]],
        'O': [[0,1,0], [1,0,1], [1,0,1], [1,0,1], [0,1,0]],
        'P': [[1,1,0], [1,0,1], [1,1,0], [1,0,0], [1,0,0]],
        'Q': [[0,1,0], [1,0,1], [1,0,1], [1,1,1], [0,1,1]],
        'R': [[1,1,0], [1,0,1], [1,1,0], [1,0,1], [1,0,1]],
        'S': [[0,1,1], [1,0,0], [0,1,0], [0,0,1], [1,1,0]],
        'T': [[1,1,1], [0,1,0], [0,1,0], [0,1,0], [0,1,0]],
        'U': [[1,0,1], [1,0,1], [1,0,1], [1,0,1], [0,1,0]],
        'V': [[1,0,1], [1,0,1], [1,0,1], [0,1,0], [0,1,0]],
        'W': [[1,0,1], [1,0,1], [1,0,1], [1,1,1], [1,0,1]],
        'X': [[1,0,1], [1,0,1], [0,1,0], [1,0,1], [1,0,1]],
        'Y': [[1,0,1], [1,0,1], [0,1,0], [0,1,0], [0,1,0]],
        'Z': [[1,1,1], [0,0,1], [0,1,0], [1,0,0], [1,1,1]],
    }

    # Numbers
    number_glyphs = {
        '0': [[0,1,0], [1,0,1], [1,0,1], [1,0,1], [0,1,0]],
        '1': [[0,1,0], [1,1,0], [0,1,0], [0,1,0], [1,1,1]],
        '2': [[0,1,0], [1,0,1], [0,0,1], [0,1,0], [1,1,1]],
        '3': [[1,1,0], [0,0,1], [0,1,0], [0,0,1], [1,1,0]],
        '4': [[1,0,1], [1,0,1], [1,1,1], [0,0,1], [0,0,1]],
        '5': [[1,1,1], [1,0,0], [1,1,0], [0,0,1], [1,1,0]],
        '6': [[0,1,1], [1,0,0], [1,1,0], [1,0,1], [0,1,0]],
        '7': [[1,1,1], [0,0,1], [0,1,0], [0,1,0], [0,1,0]],
        '8': [[0,1,0], [1,0,1], [0,1,0], [1,0,1], [0,1,0]],
        '9': [[0,1,0], [1,0,1], [0,1,1], [0,0,1], [1,1,0]],
    }

    # Punctuation
    punct_glyphs = {
        '?': [[0,1,0], [1,0,1], [0,0,1], [0,0,0], [0,1,0]],
        '!': [[0,1,0], [0,1,0], [0,1,0], [0,0,0], [0,1,0]],
        '.': [[0,0,0], [0,0,0], [0,0,0], [0,0,0], [0,1,0]],
        ',': [[0,0,0], [0,0,0], [0,0,0], [0,1,0], [1,0,0]],
        ':': [[0,0,0], [0,1,0], [0,0,0], [0,1,0], [0,0,0]],
        ';': [[0,0,0], [0,1,0], [0,0,0], [0,1,0], [1,0,0]],
        '-': [[0,0,0], [0,0,0], [1,1,1], [0,0,0], [0,0,0]],
        '+': [[0,0,0], [0,1,0], [1,1,1], [0,1,0], [0,0,0]],
        '*': [[0,0,0], [1,0,1], [0,1,0], [1,0,1], [0,0,0]],
        '#': [[1,0,1], [1,1,1], [1,0,1], [1,1,1], [1,0,1]],
        '/': [[0,0,1], [0,0,1], [0,1,0], [1,0,0], [1,0,0]],
        '(': [[0,1,0], [1,0,0], [1,0,0], [1,0,0], [0,1,0]],
        ')': [[0,1,0], [0,0,1], [0,0,1], [0,0,1], [0,1,0]],
        "'": [[0,1,0], [0,1,0], [0,0,0], [0,0,0], [0,0,0]],
        '"': [[1,0,1], [1,0,1], [0,0,0], [0,0,0], [0,0,0]],
        '=': [[0,0,0], [1,1,1], [0,0,0], [1,1,1], [0,0,0]],
        '<': [[0,0,1], [0,1,0], [1,0,0], [0,1,0], [0,0,1]],
        '>': [[1,0,0], [0,1,0], [0,0,1], [0,1,0], [1,0,0]],
        '&': [[0,1,0], [1,0,1], [0,1,0], [1,0,1], [0,1,1]],
    }

    # Add all glyphs
    for char, bitmap in {**latin_glyphs, **number_glyphs, **punct_glyphs}.items():
        font.add_glyph(char, bitmap)

    return font


def get_cyrillic_font() -> PixelFont:
    """Get a 5x7 font with Cyrillic (Russian) character support."""
    font = PixelFont(
        name="cyrillic_5x7",
        char_height=7,
        char_width=5,
        spacing=1,
    )

    # Cyrillic uppercase letters (5x7 bitmaps)
    # Russian alphabet: А Б В Г Д Е Ё Ж З И Й К Л М Н О П Р С Т У Ф Х Ц Ч Ш Щ Ъ Ы Ь Э Ю Я
    cyrillic_glyphs = {
        # А
        'А': [
            [0,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,1,1,1,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
        ],
        # Б
        'Б': [
            [1,1,1,1,1],
            [1,0,0,0,0],
            [1,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,1,1,1,0],
        ],
        # В
        'В': [
            [1,1,1,1,0],
            [1,0,0,0,1],
            [1,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,1,1,1,0],
        ],
        # Г
        'Г': [
            [1,1,1,1,1],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
        ],
        # Д
        'Д': [
            [0,1,1,1,0],
            [0,1,0,1,0],
            [0,1,0,1,0],
            [0,1,0,1,0],
            [0,1,0,1,0],
            [1,1,1,1,1],
            [1,0,0,0,1],
        ],
        # Е
        'Е': [
            [1,1,1,1,1],
            [1,0,0,0,0],
            [1,1,1,1,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,1,1,1,1],
        ],
        # Ё
        'Ё': [
            [0,1,0,1,0],
            [1,1,1,1,1],
            [1,0,0,0,0],
            [1,1,1,1,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,1,1,1,1],
        ],
        # Ж
        'Ж': [
            [1,0,1,0,1],
            [1,0,1,0,1],
            [0,1,1,1,0],
            [0,0,1,0,0],
            [0,1,1,1,0],
            [1,0,1,0,1],
            [1,0,1,0,1],
        ],
        # З
        'З': [
            [0,1,1,1,0],
            [1,0,0,0,1],
            [0,0,0,0,1],
            [0,0,1,1,0],
            [0,0,0,0,1],
            [1,0,0,0,1],
            [0,1,1,1,0],
        ],
        # И
        'И': [
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,1,1],
            [1,0,1,0,1],
            [1,1,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
        ],
        # Й
        'Й': [
            [0,1,0,1,0],
            [1,0,0,0,1],
            [1,0,0,1,1],
            [1,0,1,0,1],
            [1,1,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
        ],
        # К
        'К': [
            [1,0,0,0,1],
            [1,0,0,1,0],
            [1,0,1,0,0],
            [1,1,0,0,0],
            [1,0,1,0,0],
            [1,0,0,1,0],
            [1,0,0,0,1],
        ],
        # Л
        'Л': [
            [0,1,1,1,1],
            [0,1,0,0,1],
            [0,1,0,0,1],
            [0,1,0,0,1],
            [0,1,0,0,1],
            [0,1,0,0,1],
            [1,1,0,0,1],
        ],
        # М
        'М': [
            [1,0,0,0,1],
            [1,1,0,1,1],
            [1,0,1,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
        ],
        # Н
        'Н': [
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,1,1,1,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
        ],
        # О
        'О': [
            [0,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [0,1,1,1,0],
        ],
        # П
        'П': [
            [1,1,1,1,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
        ],
        # Р
        'Р': [
            [1,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,1,1,1,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
        ],
        # С
        'С': [
            [0,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,0,0,0,1],
            [0,1,1,1,0],
        ],
        # Т
        'Т': [
            [1,1,1,1,1],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
        ],
        # У
        'У': [
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [0,1,1,1,1],
            [0,0,0,0,1],
            [1,0,0,0,1],
            [0,1,1,1,0],
        ],
        # Ф
        'Ф': [
            [0,0,1,0,0],
            [0,1,1,1,0],
            [1,0,1,0,1],
            [1,0,1,0,1],
            [1,0,1,0,1],
            [0,1,1,1,0],
            [0,0,1,0,0],
        ],
        # Х
        'Х': [
            [1,0,0,0,1],
            [1,0,0,0,1],
            [0,1,0,1,0],
            [0,0,1,0,0],
            [0,1,0,1,0],
            [1,0,0,0,1],
            [1,0,0,0,1],
        ],
        # Ц
        'Ц': [
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,1,1,1,1],
            [0,0,0,0,1],
        ],
        # Ч
        'Ч': [
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [0,1,1,1,1],
            [0,0,0,0,1],
            [0,0,0,0,1],
            [0,0,0,0,1],
        ],
        # Ш
        'Ш': [
            [1,0,1,0,1],
            [1,0,1,0,1],
            [1,0,1,0,1],
            [1,0,1,0,1],
            [1,0,1,0,1],
            [1,0,1,0,1],
            [1,1,1,1,1],
        ],
        # Щ
        'Щ': [
            [1,0,1,0,1],
            [1,0,1,0,1],
            [1,0,1,0,1],
            [1,0,1,0,1],
            [1,0,1,0,1],
            [1,1,1,1,1],
            [0,0,0,0,1],
        ],
        # Ъ
        'Ъ': [
            [1,1,0,0,0],
            [0,1,0,0,0],
            [0,1,0,0,0],
            [0,1,1,1,0],
            [0,1,0,0,1],
            [0,1,0,0,1],
            [0,1,1,1,0],
        ],
        # Ы
        'Ы': [
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,1,1,0,1],
            [1,0,0,1,1],
            [1,0,0,1,1],
            [1,1,1,0,1],
        ],
        # Ь
        'Ь': [
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,1,1,1,0],
        ],
        # Э
        'Э': [
            [0,1,1,1,0],
            [1,0,0,0,1],
            [0,0,0,0,1],
            [0,0,1,1,1],
            [0,0,0,0,1],
            [1,0,0,0,1],
            [0,1,1,1,0],
        ],
        # Ю
        'Ю': [
            [1,0,0,1,0],
            [1,0,1,0,1],
            [1,0,1,0,1],
            [1,1,1,0,1],
            [1,0,1,0,1],
            [1,0,1,0,1],
            [1,0,0,1,0],
        ],
        # Я
        'Я': [
            [0,1,1,1,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [0,1,1,1,1],
            [0,0,1,0,1],
            [0,1,0,0,1],
            [1,0,0,0,1],
        ],
    }

    # Add lowercase versions (map to uppercase)
    lowercase_map = {
        'а': 'А', 'б': 'Б', 'в': 'В', 'г': 'Г', 'д': 'Д', 'е': 'Е', 'ё': 'Ё',
        'ж': 'Ж', 'з': 'З', 'и': 'И', 'й': 'Й', 'к': 'К', 'л': 'Л', 'м': 'М',
        'н': 'Н', 'о': 'О', 'п': 'П', 'р': 'Р', 'с': 'С', 'т': 'Т', 'у': 'У',
        'ф': 'Ф', 'х': 'Х', 'ц': 'Ц', 'ч': 'Ч', 'ш': 'Ш', 'щ': 'Щ', 'ъ': 'Ъ',
        'ы': 'Ы', 'ь': 'Ь', 'э': 'Э', 'ю': 'Ю', 'я': 'Я',
    }

    # Latin letters (5x7)
    latin_glyphs = {
        'A': [
            [0,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,1,1,1,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
        ],
        'B': [
            [1,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,1,1,1,0],
        ],
        'C': [
            [0,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,0,0,0,1],
            [0,1,1,1,0],
        ],
        'D': [
            [1,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,1,1,1,0],
        ],
        'E': [
            [1,1,1,1,1],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,1,1,1,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,1,1,1,1],
        ],
        'F': [
            [1,1,1,1,1],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,1,1,1,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
        ],
        'G': [
            [0,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,0],
            [1,0,1,1,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [0,1,1,1,0],
        ],
        'H': [
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,1,1,1,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
        ],
        'I': [
            [1,1,1,1,1],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [1,1,1,1,1],
        ],
        'J': [
            [0,0,1,1,1],
            [0,0,0,1,0],
            [0,0,0,1,0],
            [0,0,0,1,0],
            [1,0,0,1,0],
            [1,0,0,1,0],
            [0,1,1,0,0],
        ],
        'K': [
            [1,0,0,0,1],
            [1,0,0,1,0],
            [1,0,1,0,0],
            [1,1,0,0,0],
            [1,0,1,0,0],
            [1,0,0,1,0],
            [1,0,0,0,1],
        ],
        'L': [
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,1,1,1,1],
        ],
        'M': [
            [1,0,0,0,1],
            [1,1,0,1,1],
            [1,0,1,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
        ],
        'N': [
            [1,0,0,0,1],
            [1,1,0,0,1],
            [1,0,1,0,1],
            [1,0,0,1,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
        ],
        'O': [
            [0,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [0,1,1,1,0],
        ],
        'P': [
            [1,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,1,1,1,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
        ],
        'Q': [
            [0,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,1,0,1],
            [1,0,0,1,0],
            [0,1,1,0,1],
        ],
        'R': [
            [1,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,1,1,1,0],
            [1,0,1,0,0],
            [1,0,0,1,0],
            [1,0,0,0,1],
        ],
        'S': [
            [0,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,0],
            [0,1,1,1,0],
            [0,0,0,0,1],
            [1,0,0,0,1],
            [0,1,1,1,0],
        ],
        'T': [
            [1,1,1,1,1],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
        ],
        'U': [
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [0,1,1,1,0],
        ],
        'V': [
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [0,1,0,1,0],
            [0,1,0,1,0],
            [0,0,1,0,0],
        ],
        'W': [
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,1,0,1],
            [1,0,1,0,1],
            [1,1,0,1,1],
            [1,0,0,0,1],
        ],
        'X': [
            [1,0,0,0,1],
            [0,1,0,1,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,1,0,1,0],
            [1,0,0,0,1],
        ],
        'Y': [
            [1,0,0,0,1],
            [0,1,0,1,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
        ],
        'Z': [
            [1,1,1,1,1],
            [0,0,0,0,1],
            [0,0,0,1,0],
            [0,0,1,0,0],
            [0,1,0,0,0],
            [1,0,0,0,0],
            [1,1,1,1,1],
        ],
    }

    # Numbers (5x7)
    number_glyphs = {
        '0': [
            [0,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,1,1],
            [1,0,1,0,1],
            [1,1,0,0,1],
            [1,0,0,0,1],
            [0,1,1,1,0],
        ],
        '1': [
            [0,0,1,0,0],
            [0,1,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,1,1,1,0],
        ],
        '2': [
            [0,1,1,1,0],
            [1,0,0,0,1],
            [0,0,0,0,1],
            [0,0,0,1,0],
            [0,0,1,0,0],
            [0,1,0,0,0],
            [1,1,1,1,1],
        ],
        '3': [
            [0,1,1,1,0],
            [1,0,0,0,1],
            [0,0,0,0,1],
            [0,0,1,1,0],
            [0,0,0,0,1],
            [1,0,0,0,1],
            [0,1,1,1,0],
        ],
        '4': [
            [0,0,0,1,0],
            [0,0,1,1,0],
            [0,1,0,1,0],
            [1,0,0,1,0],
            [1,1,1,1,1],
            [0,0,0,1,0],
            [0,0,0,1,0],
        ],
        '5': [
            [1,1,1,1,1],
            [1,0,0,0,0],
            [1,1,1,1,0],
            [0,0,0,0,1],
            [0,0,0,0,1],
            [1,0,0,0,1],
            [0,1,1,1,0],
        ],
        '6': [
            [0,0,1,1,0],
            [0,1,0,0,0],
            [1,0,0,0,0],
            [1,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [0,1,1,1,0],
        ],
        '7': [
            [1,1,1,1,1],
            [0,0,0,0,1],
            [0,0,0,1,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
        ],
        '8': [
            [0,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [0,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [0,1,1,1,0],
        ],
        '9': [
            [0,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [0,1,1,1,1],
            [0,0,0,0,1],
            [0,0,0,1,0],
            [0,1,1,0,0],
        ],
    }

    # Punctuation (5x7)
    punct_glyphs = {
        '?': [
            [0,1,1,1,0],
            [1,0,0,0,1],
            [0,0,0,0,1],
            [0,0,0,1,0],
            [0,0,1,0,0],
            [0,0,0,0,0],
            [0,0,1,0,0],
        ],
        '!': [
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,0,0,0],
            [0,0,1,0,0],
        ],
        '.': [
            [0,0,0,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
            [0,1,1,0,0],
            [0,1,1,0,0],
        ],
        ',': [
            [0,0,0,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
            [0,0,1,0,0],
            [0,1,0,0,0],
        ],
        ':': [
            [0,0,0,0,0],
            [0,0,1,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
            [0,0,1,0,0],
            [0,0,0,0,0],
        ],
        '-': [
            [0,0,0,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
            [1,1,1,1,1],
            [0,0,0,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
        ],
        ' ': [
            [0,0,0,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
        ],
        # Angle brackets (5x7)
        '<': [
            [0,0,0,0,1],
            [0,0,0,1,0],
            [0,0,1,0,0],
            [0,1,0,0,0],
            [0,0,1,0,0],
            [0,0,0,1,0],
            [0,0,0,0,1],
        ],
        '>': [
            [1,0,0,0,0],
            [0,1,0,0,0],
            [0,0,1,0,0],
            [0,0,0,1,0],
            [0,0,1,0,0],
            [0,1,0,0,0],
            [1,0,0,0,0],
        ],
        # Arrow symbols (critical for UI!)
        '←': [
            [0,0,1,0,0],
            [0,1,0,0,0],
            [1,1,1,1,1],
            [0,1,0,0,0],
            [0,0,1,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
        ],
        '→': [
            [0,0,1,0,0],
            [0,0,0,1,0],
            [1,1,1,1,1],
            [0,0,0,1,0],
            [0,0,1,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
        ],
        '▲': [
            [0,0,1,0,0],
            [0,1,1,1,0],
            [1,1,1,1,1],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
        ],
        '▼': [
            [0,0,1,0,0],
            [0,0,1,0,0],
            [1,1,1,1,1],
            [0,1,1,1,0],
            [0,0,1,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
        ],
        '◄': [
            [0,0,1,0,0],
            [0,1,1,0,0],
            [1,1,1,0,0],
            [0,1,1,0,0],
            [0,0,1,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
        ],
        '►': [
            [0,0,1,0,0],
            [0,0,1,1,0],
            [0,0,1,1,1],
            [0,0,1,1,0],
            [0,0,1,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
        ],
        # Additional useful symbols
        '●': [
            [0,0,0,0,0],
            [0,1,1,1,0],
            [1,1,1,1,1],
            [1,1,1,1,1],
            [0,1,1,1,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
        ],
        '○': [
            [0,0,0,0,0],
            [0,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [0,1,1,1,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
        ],
        '★': [
            [0,0,1,0,0],
            [0,1,1,1,0],
            [1,1,1,1,1],
            [0,1,1,1,0],
            [0,1,0,1,0],
            [1,0,0,0,1],
            [0,0,0,0,0],
        ],
        '☆': [
            [0,0,1,0,0],
            [0,0,1,0,0],
            [1,1,1,1,1],
            [0,1,0,1,0],
            [0,1,0,1,0],
            [1,0,0,0,1],
            [0,0,0,0,0],
        ],
        '◆': [
            [0,0,1,0,0],
            [0,1,1,1,0],
            [1,1,1,1,1],
            [0,1,1,1,0],
            [0,0,1,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
        ],
        '◇': [
            [0,0,1,0,0],
            [0,1,0,1,0],
            [1,0,0,0,1],
            [0,1,0,1,0],
            [0,0,1,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
        ],
        '♥': [
            [0,0,0,0,0],
            [0,1,0,1,0],
            [1,1,1,1,1],
            [0,1,1,1,0],
            [0,0,1,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
        ],
        '♡': [  # Empty heart
            [0,0,0,0,0],
            [0,1,0,1,0],
            [1,0,1,0,1],
            [0,1,0,1,0],
            [0,0,1,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
        ],
        '✓': [
            [0,0,0,0,0],
            [0,0,0,0,1],
            [0,0,0,1,0],
            [1,0,1,0,0],
            [0,1,0,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
        ],
        '✗': [
            [0,0,0,0,0],
            [1,0,0,0,1],
            [0,1,0,1,0],
            [0,0,1,0,0],
            [0,1,0,1,0],
            [1,0,0,0,1],
            [0,0,0,0,0],
        ],
        '%': [
            [1,1,0,0,1],
            [1,1,0,1,0],
            [0,0,1,0,0],
            [0,1,0,1,1],
            [1,0,0,1,1],
            [0,0,0,0,0],
            [0,0,0,0,0],
        ],
        "'": [  # Apostrophe / single quote
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,1,0,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
        ],
        '"': [  # Double quote
            [0,1,0,1,0],
            [0,1,0,1,0],
            [1,0,1,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
        ],
        ';': [  # Semicolon
            [0,0,0,0,0],
            [0,0,1,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
            [0,0,1,0,0],
            [0,1,0,0,0],
            [0,0,0,0,0],
        ],
        '/': [
            [0,0,0,0,1],
            [0,0,0,1,0],
            [0,0,1,0,0],
            [0,1,0,0,0],
            [1,0,0,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
        ],
        '(': [
            [0,0,0,1,0],
            [0,0,1,0,0],
            [0,1,0,0,0],
            [0,1,0,0,0],
            [0,1,0,0,0],
            [0,0,1,0,0],
            [0,0,0,1,0],
        ],
        ')': [
            [0,1,0,0,0],
            [0,0,1,0,0],
            [0,0,0,1,0],
            [0,0,0,1,0],
            [0,0,0,1,0],
            [0,0,1,0,0],
            [0,1,0,0,0],
        ],
        '#': [
            [0,1,0,1,0],
            [0,1,0,1,0],
            [1,1,1,1,1],
            [0,1,0,1,0],
            [1,1,1,1,1],
            [0,1,0,1,0],
            [0,1,0,1,0],
        ],
        '+': [
            [0,0,0,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [1,1,1,1,1],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,0,0,0],
        ],
        '=': [
            [0,0,0,0,0],
            [0,0,0,0,0],
            [1,1,1,1,1],
            [0,0,0,0,0],
            [1,1,1,1,1],
            [0,0,0,0,0],
            [0,0,0,0,0],
        ],
        '&': [
            [0,1,1,0,0],
            [1,0,0,1,0],
            [0,1,1,0,0],
            [1,0,0,1,0],
            [1,0,0,0,1],
            [1,0,0,1,0],
            [0,1,1,0,1],
        ],
    }

    # Add all glyphs to font
    for char, bitmap in cyrillic_glyphs.items():
        font.add_glyph(char, bitmap)

    for lower, upper in lowercase_map.items():
        if upper in cyrillic_glyphs:
            font.add_glyph(lower, cyrillic_glyphs[upper])

    for char, bitmap in latin_glyphs.items():
        font.add_glyph(char, bitmap)
        font.add_glyph(char.lower(), bitmap)

    for char, bitmap in number_glyphs.items():
        font.add_glyph(char, bitmap)

    for char, bitmap in punct_glyphs.items():
        font.add_glyph(char, bitmap)

    return font


# Font cache
_font_cache: Dict[str, PixelFont] = {}


def load_font(name: str) -> PixelFont:
    """Load a font by name, with caching.

    Args:
        name: Font name ("default" or "cyrillic")

    Returns:
        The requested PixelFont
    """
    if name in _font_cache:
        return _font_cache[name]

    if name == "default":
        font = get_default_font()
    elif name == "cyrillic":
        font = get_cyrillic_font()
    else:
        raise ValueError(f"Unknown font: {name}")

    _font_cache[name] = font
    return font


def center_text_x(text: str, font: PixelFont, scale: int = 1, display_width: int = 128) -> int:
    """Calculate X position to center text on display.

    Args:
        text: Text string to center
        font: PixelFont instance
        scale: Scale factor
        display_width: Width of display in pixels

    Returns:
        X coordinate for centered text
    """
    text_w, _ = font.measure_text(text)
    return max(0, (display_width - text_w * scale) // 2)


def wrap_text(text: str, max_chars: int) -> List[str]:
    """Word-wrap text to fit within character limit.

    Args:
        text: Text to wrap
        max_chars: Maximum characters per line

    Returns:
        List of wrapped lines
    """
    words = text.split()
    lines: List[str] = []
    current_line = ""

    for word in words:
        test_line = current_line + " " + word if current_line else word
        if len(test_line) <= max_chars:
            current_line = test_line
        else:
            if current_line:
                lines.append(current_line)
            current_line = word

    if current_line:
        lines.append(current_line)

    return lines


def draw_text_centered(
    buffer: NDArray[np.uint8],
    text: str,
    y: int,
    color: Tuple[int, int, int],
    font: PixelFont,
    scale: int = 1,
    display_width: int = 128,
) -> Tuple[int, int]:
    """Draw centered text on buffer.

    Args:
        buffer: Target numpy array
        text: Text to draw
        y: Y coordinate
        color: RGB color
        font: PixelFont instance
        scale: Scale factor
        display_width: Width of display

    Returns:
        Tuple of (width, height) of rendered text
    """
    x = center_text_x(text, font, scale, display_width)
    return draw_text_bitmap(buffer, text, x, y, color, font, scale)


def get_ticker_font() -> PixelFont:
    """Get a 5x8 font optimized for the 8-pixel tall ticker display.

    This font fills the full 8 rows of the ticker for maximum visibility.
    """
    font = PixelFont(
        name="ticker_5x8",
        char_height=8,
        char_width=5,
        spacing=1,
    )

    # Latin uppercase letters (5x8 bitmaps)
    latin_glyphs = {
        'A': [
            [0,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,1,1,1,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
        ],
        'B': [
            [1,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,1,1,1,0],
        ],
        'C': [
            [0,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,0,0,0,1],
            [0,1,1,1,0],
        ],
        'D': [
            [1,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,1,1,1,0],
        ],
        'E': [
            [1,1,1,1,1],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,1,1,1,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,1,1,1,1],
        ],
        'F': [
            [1,1,1,1,1],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,1,1,1,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
        ],
        'G': [
            [0,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,0,1,1,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [0,1,1,1,0],
        ],
        'H': [
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,1,1,1,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
        ],
        'I': [
            [1,1,1,1,1],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [1,1,1,1,1],
        ],
        'J': [
            [0,0,1,1,1],
            [0,0,0,1,0],
            [0,0,0,1,0],
            [0,0,0,1,0],
            [0,0,0,1,0],
            [1,0,0,1,0],
            [1,0,0,1,0],
            [0,1,1,0,0],
        ],
        'K': [
            [1,0,0,0,1],
            [1,0,0,1,0],
            [1,0,1,0,0],
            [1,1,0,0,0],
            [1,1,0,0,0],
            [1,0,1,0,0],
            [1,0,0,1,0],
            [1,0,0,0,1],
        ],
        'L': [
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,1,1,1,1],
        ],
        'M': [
            [1,0,0,0,1],
            [1,1,0,1,1],
            [1,0,1,0,1],
            [1,0,1,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
        ],
        'N': [
            [1,0,0,0,1],
            [1,1,0,0,1],
            [1,0,1,0,1],
            [1,0,1,0,1],
            [1,0,0,1,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
        ],
        'O': [
            [0,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [0,1,1,1,0],
        ],
        'P': [
            [1,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,1,1,1,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
        ],
        'Q': [
            [0,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,1,0,1],
            [1,0,0,1,0],
            [0,1,1,0,1],
        ],
        'R': [
            [1,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,1,1,1,0],
            [1,0,1,0,0],
            [1,0,0,1,0],
            [1,0,0,0,1],
            [1,0,0,0,1],
        ],
        'S': [
            [0,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,0],
            [0,1,1,1,0],
            [0,0,0,0,1],
            [0,0,0,0,1],
            [1,0,0,0,1],
            [0,1,1,1,0],
        ],
        'T': [
            [1,1,1,1,1],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
        ],
        'U': [
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [0,1,1,1,0],
        ],
        'V': [
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [0,1,0,1,0],
            [0,1,0,1,0],
            [0,0,1,0,0],
        ],
        'W': [
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,1,0,1],
            [1,0,1,0,1],
            [1,1,0,1,1],
            [1,0,0,0,1],
        ],
        'X': [
            [1,0,0,0,1],
            [1,0,0,0,1],
            [0,1,0,1,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,1,0,1,0],
            [1,0,0,0,1],
            [1,0,0,0,1],
        ],
        'Y': [
            [1,0,0,0,1],
            [1,0,0,0,1],
            [0,1,0,1,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
        ],
        'Z': [
            [1,1,1,1,1],
            [0,0,0,0,1],
            [0,0,0,1,0],
            [0,0,1,0,0],
            [0,1,0,0,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,1,1,1,1],
        ],
    }

    # Numbers (5x8)
    number_glyphs = {
        '0': [
            [0,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,1,1],
            [1,0,1,0,1],
            [1,1,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [0,1,1,1,0],
        ],
        '1': [
            [0,0,1,0,0],
            [0,1,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,1,1,1,0],
        ],
        '2': [
            [0,1,1,1,0],
            [1,0,0,0,1],
            [0,0,0,0,1],
            [0,0,0,1,0],
            [0,0,1,0,0],
            [0,1,0,0,0],
            [1,0,0,0,0],
            [1,1,1,1,1],
        ],
        '3': [
            [0,1,1,1,0],
            [1,0,0,0,1],
            [0,0,0,0,1],
            [0,0,1,1,0],
            [0,0,0,0,1],
            [0,0,0,0,1],
            [1,0,0,0,1],
            [0,1,1,1,0],
        ],
        '4': [
            [0,0,0,1,0],
            [0,0,1,1,0],
            [0,1,0,1,0],
            [1,0,0,1,0],
            [1,1,1,1,1],
            [0,0,0,1,0],
            [0,0,0,1,0],
            [0,0,0,1,0],
        ],
        '5': [
            [1,1,1,1,1],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,1,1,1,0],
            [0,0,0,0,1],
            [0,0,0,0,1],
            [1,0,0,0,1],
            [0,1,1,1,0],
        ],
        '6': [
            [0,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,0],
            [1,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [0,1,1,1,0],
        ],
        '7': [
            [1,1,1,1,1],
            [0,0,0,0,1],
            [0,0,0,1,0],
            [0,0,0,1,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,1,0,0,0],
            [0,1,0,0,0],
        ],
        '8': [
            [0,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [0,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [0,1,1,1,0],
        ],
        '9': [
            [0,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [0,1,1,1,1],
            [0,0,0,0,1],
            [1,0,0,0,1],
            [0,1,1,1,0],
        ],
    }

    # Punctuation (5x8)
    punct_glyphs = {
        ' ': [[0,0,0,0,0]] * 8,
        '.': [
            [0,0,0,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
            [0,1,1,0,0],
            [0,1,1,0,0],
        ],
        ',': [
            [0,0,0,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
            [0,1,1,0,0],
            [0,0,1,0,0],
            [0,1,0,0,0],
        ],
        '!': [
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,0,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
        ],
        '?': [
            [0,1,1,1,0],
            [1,0,0,0,1],
            [0,0,0,0,1],
            [0,0,0,1,0],
            [0,0,1,0,0],
            [0,0,0,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
        ],
        ':': [
            [0,0,0,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,0,0,0],
        ],
        '-': [
            [0,0,0,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
            [1,1,1,1,1],
            [0,0,0,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
        ],
    }

    # Cyrillic uppercase (5x8)
    cyrillic_glyphs = {
        'А': [
            [0,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,1,1,1,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
        ],
        'Б': [
            [1,1,1,1,1],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,1,1,1,0],
        ],
        'В': [
            [1,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,1,1,1,0],
        ],
        'Г': [
            [1,1,1,1,1],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
        ],
        'Д': [
            [0,1,1,1,0],
            [0,1,0,1,0],
            [0,1,0,1,0],
            [0,1,0,1,0],
            [0,1,0,1,0],
            [0,1,0,1,0],
            [1,1,1,1,1],
            [1,0,0,0,1],
        ],
        'Е': [
            [1,1,1,1,1],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,1,1,1,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,1,1,1,1],
        ],
        'Ж': [
            [1,0,1,0,1],
            [1,0,1,0,1],
            [0,1,1,1,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,1,1,1,0],
            [1,0,1,0,1],
            [1,0,1,0,1],
        ],
        'З': [
            [0,1,1,1,0],
            [1,0,0,0,1],
            [0,0,0,0,1],
            [0,0,1,1,0],
            [0,0,0,0,1],
            [0,0,0,0,1],
            [1,0,0,0,1],
            [0,1,1,1,0],
        ],
        'И': [
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,1,1],
            [1,0,1,0,1],
            [1,0,1,0,1],
            [1,1,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
        ],
        'Й': [
            [0,1,0,1,0],
            [1,0,0,0,1],
            [1,0,0,1,1],
            [1,0,1,0,1],
            [1,0,1,0,1],
            [1,1,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
        ],
        'К': [
            [1,0,0,0,1],
            [1,0,0,1,0],
            [1,0,1,0,0],
            [1,1,0,0,0],
            [1,1,0,0,0],
            [1,0,1,0,0],
            [1,0,0,1,0],
            [1,0,0,0,1],
        ],
        'Л': [
            [0,1,1,1,1],
            [0,1,0,0,1],
            [0,1,0,0,1],
            [0,1,0,0,1],
            [0,1,0,0,1],
            [0,1,0,0,1],
            [0,1,0,0,1],
            [1,1,0,0,1],
        ],
        'М': [
            [1,0,0,0,1],
            [1,1,0,1,1],
            [1,0,1,0,1],
            [1,0,1,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
        ],
        'Н': [
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,1,1,1,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
        ],
        'О': [
            [0,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [0,1,1,1,0],
        ],
        'П': [
            [1,1,1,1,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
        ],
        'Р': [
            [1,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,1,1,1,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
        ],
        'С': [
            [0,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,0,0,0,1],
            [0,1,1,1,0],
        ],
        'Т': [
            [1,1,1,1,1],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
        ],
        'У': [
            [1,0,0,0,1],
            [1,0,0,0,1],
            [0,1,0,1,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
        ],
        'Ф': [
            [0,0,1,0,0],
            [0,1,1,1,0],
            [1,0,1,0,1],
            [1,0,1,0,1],
            [1,0,1,0,1],
            [0,1,1,1,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
        ],
        'Х': [
            [1,0,0,0,1],
            [1,0,0,0,1],
            [0,1,0,1,0],
            [0,0,1,0,0],
            [0,0,1,0,0],
            [0,1,0,1,0],
            [1,0,0,0,1],
            [1,0,0,0,1],
        ],
        'Ц': [
            [1,0,0,1,0],
            [1,0,0,1,0],
            [1,0,0,1,0],
            [1,0,0,1,0],
            [1,0,0,1,0],
            [1,0,0,1,0],
            [1,1,1,1,1],
            [0,0,0,0,1],
        ],
        'Ч': [
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [0,1,1,1,1],
            [0,0,0,0,1],
            [0,0,0,0,1],
            [0,0,0,0,1],
            [0,0,0,0,1],
        ],
        'Ш': [
            [1,0,1,0,1],
            [1,0,1,0,1],
            [1,0,1,0,1],
            [1,0,1,0,1],
            [1,0,1,0,1],
            [1,0,1,0,1],
            [1,0,1,0,1],
            [1,1,1,1,1],
        ],
        'Щ': [
            [1,0,1,0,1],
            [1,0,1,0,1],
            [1,0,1,0,1],
            [1,0,1,0,1],
            [1,0,1,0,1],
            [1,0,1,0,1],
            [1,1,1,1,1],
            [0,0,0,0,1],
        ],
        'Ъ': [
            [1,1,0,0,0],
            [0,1,0,0,0],
            [0,1,0,0,0],
            [0,1,1,1,0],
            [0,1,0,0,1],
            [0,1,0,0,1],
            [0,1,0,0,1],
            [0,1,1,1,0],
        ],
        'Ы': [
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,1,1,0,1],
            [1,0,0,1,1],
            [1,0,0,1,1],
            [1,0,0,1,1],
            [1,1,1,0,1],
        ],
        'Ь': [
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,0,0,0,0],
            [1,1,1,1,0],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [1,1,1,1,0],
        ],
        'Э': [
            [0,1,1,1,0],
            [1,0,0,0,1],
            [0,0,0,0,1],
            [0,0,1,1,1],
            [0,0,0,0,1],
            [0,0,0,0,1],
            [1,0,0,0,1],
            [0,1,1,1,0],
        ],
        'Ю': [
            [1,0,0,1,0],
            [1,0,1,0,1],
            [1,0,1,0,1],
            [1,1,1,0,1],
            [1,0,1,0,1],
            [1,0,1,0,1],
            [1,0,1,0,1],
            [1,0,0,1,0],
        ],
        'Я': [
            [0,1,1,1,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
            [0,1,1,1,1],
            [0,0,1,0,1],
            [0,1,0,0,1],
            [1,0,0,0,1],
            [1,0,0,0,1],
        ],
    }

    # Lowercase Cyrillic maps to uppercase
    lowercase_map = {
        'а': 'А', 'б': 'Б', 'в': 'В', 'г': 'Г', 'д': 'Д', 'е': 'Е',
        'ж': 'Ж', 'з': 'З', 'и': 'И', 'й': 'Й', 'к': 'К', 'л': 'Л',
        'м': 'М', 'н': 'Н', 'о': 'О', 'п': 'П', 'р': 'Р', 'с': 'С',
        'т': 'Т', 'у': 'У', 'ф': 'Ф', 'х': 'Х', 'ц': 'Ц', 'ч': 'Ч',
        'ш': 'Ш', 'щ': 'Щ', 'ъ': 'Ъ', 'ы': 'Ы', 'ь': 'Ь', 'э': 'Э',
        'ю': 'Ю', 'я': 'Я',
    }

    # Lowercase Latin maps to uppercase
    latin_lowercase = {chr(c): chr(c - 32) for c in range(ord('a'), ord('z') + 1)}

    # Add all glyphs
    for char, bitmap in {**latin_glyphs, **number_glyphs, **punct_glyphs, **cyrillic_glyphs}.items():
        font.add_glyph(char, bitmap)

    # Add lowercase mappings
    for lower, upper in {**lowercase_map, **latin_lowercase}.items():
        if upper in font.glyphs:
            font.add_glyph(lower, font.glyphs[upper])

    return font
